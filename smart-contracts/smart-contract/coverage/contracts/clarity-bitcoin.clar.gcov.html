<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.lcov - contracts/clarity-bitcoin.clar</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">contracts</a> - clarity-bitcoin.clar<span style="font-size: 80%;"> (source / <a href="clarity-bitcoin.clar.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.lcov</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">313</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2023-08-18 21:53:02</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">39</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : ;; Error codes</a>
<a name="2"><span class="lineNum">       2 </span>                :            : (define-constant ERR-OUT-OF-BOUNDS u1)</a>
<a name="3"><span class="lineNum">       3 </span>                :            : (define-constant ERR-TOO-MANY-TXINS u2)</a>
<a name="4"><span class="lineNum">       4 </span>                :            : (define-constant ERR-TOO-MANY-TXOUTS u3)</a>
<a name="5"><span class="lineNum">       5 </span>                :            : (define-constant ERR-VARSLICE-TOO-LONG u4)</a>
<a name="6"><span class="lineNum">       6 </span>                :            : (define-constant ERR-BAD-HEADER u5)</a>
<a name="7"><span class="lineNum">       7 </span>                :            : (define-constant ERR-PROOF-TOO-SHORT u6)</a>
<a name="8"><span class="lineNum">       8 </span>                :            : (define-constant ERR-INVALID-PARENT u7)</a>
<a name="9"><span class="lineNum">       9 </span>                :            : </a>
<a name="10"><span class="lineNum">      10 </span>                :            : ;; lookup table for converting 1-byte buffers to uints via index-of</a>
<a name="11"><span class="lineNum">      11 </span>                :            : (define-constant BUFF_TO_BYTE (list </a>
<a name="12"><span class="lineNum">      12 </span>                :            :    0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0a 0x0b 0x0c 0x0d 0x0e 0x0f</a>
<a name="13"><span class="lineNum">      13 </span>                :            :    0x10 0x11 0x12 0x13 0x14 0x15 0x16 0x17 0x18 0x19 0x1a 0x1b 0x1c 0x1d 0x1e 0x1f</a>
<a name="14"><span class="lineNum">      14 </span>                :            :    0x20 0x21 0x22 0x23 0x24 0x25 0x26 0x27 0x28 0x29 0x2a 0x2b 0x2c 0x2d 0x2e 0x2f</a>
<a name="15"><span class="lineNum">      15 </span>                :            :    0x30 0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38 0x39 0x3a 0x3b 0x3c 0x3d 0x3e 0x3f</a>
<a name="16"><span class="lineNum">      16 </span>                :            :    0x40 0x41 0x42 0x43 0x44 0x45 0x46 0x47 0x48 0x49 0x4a 0x4b 0x4c 0x4d 0x4e 0x4f</a>
<a name="17"><span class="lineNum">      17 </span>                :            :    0x50 0x51 0x52 0x53 0x54 0x55 0x56 0x57 0x58 0x59 0x5a 0x5b 0x5c 0x5d 0x5e 0x5f</a>
<a name="18"><span class="lineNum">      18 </span>                :            :    0x60 0x61 0x62 0x63 0x64 0x65 0x66 0x67 0x68 0x69 0x6a 0x6b 0x6c 0x6d 0x6e 0x6f</a>
<a name="19"><span class="lineNum">      19 </span>                :            :    0x70 0x71 0x72 0x73 0x74 0x75 0x76 0x77 0x78 0x79 0x7a 0x7b 0x7c 0x7d 0x7e 0x7f</a>
<a name="20"><span class="lineNum">      20 </span>                :            :    0x80 0x81 0x82 0x83 0x84 0x85 0x86 0x87 0x88 0x89 0x8a 0x8b 0x8c 0x8d 0x8e 0x8f</a>
<a name="21"><span class="lineNum">      21 </span>                :            :    0x90 0x91 0x92 0x93 0x94 0x95 0x96 0x97 0x98 0x99 0x9a 0x9b 0x9c 0x9d 0x9e 0x9f</a>
<a name="22"><span class="lineNum">      22 </span>                :            :    0xa0 0xa1 0xa2 0xa3 0xa4 0xa5 0xa6 0xa7 0xa8 0xa9 0xaa 0xab 0xac 0xad 0xae 0xaf</a>
<a name="23"><span class="lineNum">      23 </span>                :            :    0xb0 0xb1 0xb2 0xb3 0xb4 0xb5 0xb6 0xb7 0xb8 0xb9 0xba 0xbb 0xbc 0xbd 0xbe 0xbf</a>
<a name="24"><span class="lineNum">      24 </span>                :            :    0xc0 0xc1 0xc2 0xc3 0xc4 0xc5 0xc6 0xc7 0xc8 0xc9 0xca 0xcb 0xcc 0xcd 0xce 0xcf</a>
<a name="25"><span class="lineNum">      25 </span>                :            :    0xd0 0xd1 0xd2 0xd3 0xd4 0xd5 0xd6 0xd7 0xd8 0xd9 0xda 0xdb 0xdc 0xdd 0xde 0xdf</a>
<a name="26"><span class="lineNum">      26 </span>                :            :    0xe0 0xe1 0xe2 0xe3 0xe4 0xe5 0xe6 0xe7 0xe8 0xe9 0xea 0xeb 0xec 0xed 0xee 0xef</a>
<a name="27"><span class="lineNum">      27 </span>                :            :    0xf0 0xf1 0xf2 0xf3 0xf4 0xf5 0xf6 0xf7 0xf8 0xf9 0xfa 0xfb 0xfc 0xfd 0xfe 0xff</a>
<a name="28"><span class="lineNum">      28 </span>                :            : ))</a>
<a name="29"><span class="lineNum">      29 </span>                :            : </a>
<a name="30"><span class="lineNum">      30 </span>                :            : ;; List with 512 items, used for folding something 512 times</a>
<a name="31"><span class="lineNum">      31 </span>                :            : (define-constant LIST_512 (list</a>
<a name="32"><span class="lineNum">      32 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="33"><span class="lineNum">      33 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="34"><span class="lineNum">      34 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="35"><span class="lineNum">      35 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="36"><span class="lineNum">      36 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="37"><span class="lineNum">      37 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="38"><span class="lineNum">      38 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="39"><span class="lineNum">      39 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="40"><span class="lineNum">      40 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="41"><span class="lineNum">      41 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="42"><span class="lineNum">      42 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="43"><span class="lineNum">      43 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="44"><span class="lineNum">      44 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="45"><span class="lineNum">      45 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="46"><span class="lineNum">      46 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="47"><span class="lineNum">      47 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="48"><span class="lineNum">      48 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="49"><span class="lineNum">      49 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="50"><span class="lineNum">      50 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="51"><span class="lineNum">      51 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="52"><span class="lineNum">      52 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="53"><span class="lineNum">      53 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="54"><span class="lineNum">      54 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="55"><span class="lineNum">      55 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="56"><span class="lineNum">      56 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="57"><span class="lineNum">      57 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="58"><span class="lineNum">      58 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="59"><span class="lineNum">      59 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="60"><span class="lineNum">      60 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="61"><span class="lineNum">      61 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="62"><span class="lineNum">      62 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="63"><span class="lineNum">      63 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="64"><span class="lineNum">      64 </span>                :            : ))</a>
<a name="65"><span class="lineNum">      65 </span>                :            : </a>
<a name="66"><span class="lineNum">      66 </span>                :            : ;; List with 256 items, used for folding something 256 times</a>
<a name="67"><span class="lineNum">      67 </span>                :            : (define-constant LIST_256 (list</a>
<a name="68"><span class="lineNum">      68 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="69"><span class="lineNum">      69 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="70"><span class="lineNum">      70 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="71"><span class="lineNum">      71 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="72"><span class="lineNum">      72 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="73"><span class="lineNum">      73 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="74"><span class="lineNum">      74 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="75"><span class="lineNum">      75 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="76"><span class="lineNum">      76 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="77"><span class="lineNum">      77 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="78"><span class="lineNum">      78 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="79"><span class="lineNum">      79 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="80"><span class="lineNum">      80 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="81"><span class="lineNum">      81 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="82"><span class="lineNum">      82 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="83"><span class="lineNum">      83 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="84"><span class="lineNum">      84 </span>                :            : ))</a>
<a name="85"><span class="lineNum">      85 </span>                :            : </a>
<a name="86"><span class="lineNum">      86 </span>                :            : ;; List with 128 items, used for folding something 128 times</a>
<a name="87"><span class="lineNum">      87 </span>                :            : (define-constant LIST_128 (list</a>
<a name="88"><span class="lineNum">      88 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="89"><span class="lineNum">      89 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="90"><span class="lineNum">      90 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="91"><span class="lineNum">      91 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="92"><span class="lineNum">      92 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="93"><span class="lineNum">      93 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="94"><span class="lineNum">      94 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="95"><span class="lineNum">      95 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="96"><span class="lineNum">      96 </span>                :            : ))</a>
<a name="97"><span class="lineNum">      97 </span>                :            : </a>
<a name="98"><span class="lineNum">      98 </span>                :            : ;; List with 64 items, used for folding something 64 times</a>
<a name="99"><span class="lineNum">      99 </span>                :            : (define-constant LIST_64 (list</a>
<a name="100"><span class="lineNum">     100 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="101"><span class="lineNum">     101 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="102"><span class="lineNum">     102 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="103"><span class="lineNum">     103 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="104"><span class="lineNum">     104 </span>                :            : ))</a>
<a name="105"><span class="lineNum">     105 </span>                :            : </a>
<a name="106"><span class="lineNum">     106 </span>                :            : ;; List with 32 items, used for folding something 32 times</a>
<a name="107"><span class="lineNum">     107 </span>                :            : (define-constant LIST_32 (list</a>
<a name="108"><span class="lineNum">     108 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="109"><span class="lineNum">     109 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="110"><span class="lineNum">     110 </span>                :            : ))</a>
<a name="111"><span class="lineNum">     111 </span>                :            : </a>
<a name="112"><span class="lineNum">     112 </span>                :            : ;; List with 16 items, used for folding something 16 times</a>
<a name="113"><span class="lineNum">     113 </span>                :            : (define-constant LIST_16 (list</a>
<a name="114"><span class="lineNum">     114 </span>                :            :    true true true true true true true true true true true true true true true true</a>
<a name="115"><span class="lineNum">     115 </span>                :            : ))</a>
<a name="116"><span class="lineNum">     116 </span>                :            : </a>
<a name="117"><span class="lineNum">     117 </span>                :            : ;; Convert a 1-byte buff into a uint.</a>
<a name="118"><span class="lineNum">     118 </span>                :            : (define-read-only (buff-to-u8 (byte (buff 1)))</a>
<a name="119"><span class="lineNum">     119 </span>                :<span class="lineNoCov">          0 :     (unwrap-panic (index-of BUFF_TO_BYTE byte)))</span></a>
<a name="120"><span class="lineNum">     120 </span>                :            : </a>
<a name="121"><span class="lineNum">     121 </span>                :            : ;; Append a byte at the given index in the given data to acc.</a>
<a name="122"><span class="lineNum">     122 </span>                :            : (define-read-only (inner-read-slice-1024 (ignored bool) (input { acc: (buff 1024), data: (buff 1024), index: uint }))</a>
<a name="123"><span class="lineNum">     123 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="124"><span class="lineNum">     124 </span>                :<span class="lineNoCov">          0 :         (acc (get acc input))</span></a>
<a name="125"><span class="lineNum">     125 </span>                :<span class="lineNoCov">          0 :         (data (get data input))</span></a>
<a name="126"><span class="lineNum">     126 </span>                :<span class="lineNoCov">          0 :         (ctr (get index input))</span></a>
<a name="127"><span class="lineNum">     127 </span>                :<span class="lineNoCov">          0 :         (byte (unwrap-panic (element-at data ctr)))</span></a>
<a name="128"><span class="lineNum">     128 </span>                :            :     )</a>
<a name="129"><span class="lineNum">     129 </span>                :            :     {</a>
<a name="130"><span class="lineNum">     130 </span>                :<span class="lineNoCov">          0 :         acc: (unwrap-panic (as-max-len? (concat acc byte) u1024)),</span></a>
<a name="131"><span class="lineNum">     131 </span>                :<span class="lineNoCov">          0 :         data: data,</span></a>
<a name="132"><span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 :         index: (+ u1 ctr)</span></a>
<a name="133"><span class="lineNum">     133 </span>                :            :     })</a>
<a name="134"><span class="lineNum">     134 </span>                :            : )</a>
<a name="135"><span class="lineNum">     135 </span>                :            : </a>
<a name="136"><span class="lineNum">     136 </span>                :            : ;; Read 512 bytes from data, starting at index.  Return the 512-byte slice.</a>
<a name="137"><span class="lineNum">     137 </span>                :            : (define-read-only (read-slice-512 (input { data: (buff 1024), index: uint }))</a>
<a name="138"><span class="lineNum">     138 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="139"><span class="lineNum">     139 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_512 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="140"><span class="lineNum">     140 </span>                :            : </a>
<a name="141"><span class="lineNum">     141 </span>                :            : ;; Read 256 bytes from data, starting at index.  Return the 256-byte slice.</a>
<a name="142"><span class="lineNum">     142 </span>                :            : (define-read-only (read-slice-256 (input { data: (buff 1024), index: uint }))</a>
<a name="143"><span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="144"><span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_256 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="145"><span class="lineNum">     145 </span>                :            : </a>
<a name="146"><span class="lineNum">     146 </span>                :            : ;; Read 128 bytes from data, starting at index.  Return the 128-byte slice.</a>
<a name="147"><span class="lineNum">     147 </span>                :            : (define-read-only (read-slice-128 (input { data: (buff 1024), index: uint }))</a>
<a name="148"><span class="lineNum">     148 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="149"><span class="lineNum">     149 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_128 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="150"><span class="lineNum">     150 </span>                :            : </a>
<a name="151"><span class="lineNum">     151 </span>                :            : ;; Read 64 bytes from data, starting at index.  Return the 64-byte slice.</a>
<a name="152"><span class="lineNum">     152 </span>                :            : (define-read-only (read-slice-64 (input { data: (buff 1024), index: uint }))</a>
<a name="153"><span class="lineNum">     153 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="154"><span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_64 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="155"><span class="lineNum">     155 </span>                :            : </a>
<a name="156"><span class="lineNum">     156 </span>                :            : ;; Read 32 bytes from data, starting at index.  Return the 32-byte slice.</a>
<a name="157"><span class="lineNum">     157 </span>                :            : (define-read-only (read-slice-32 (input { data: (buff 1024), index: uint }))</a>
<a name="158"><span class="lineNum">     158 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="159"><span class="lineNum">     159 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_32 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="160"><span class="lineNum">     160 </span>                :            : </a>
<a name="161"><span class="lineNum">     161 </span>                :            : ;; Read 16 bytes from data, starting at index.  Return the 16-byte slice.</a>
<a name="162"><span class="lineNum">     162 </span>                :            : (define-read-only (read-slice-16 (input { data: (buff 1024), index: uint }))</a>
<a name="163"><span class="lineNum">     163 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="164"><span class="lineNum">     164 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 LIST_16 { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="165"><span class="lineNum">     165 </span>                :            : </a>
<a name="166"><span class="lineNum">     166 </span>                :            : ;; Read 8 bytes from data, starting at index.  Return the 8-byte slice.</a>
<a name="167"><span class="lineNum">     167 </span>                :            : (define-read-only (read-slice-8 (input { data: (buff 1024), index: uint }))</a>
<a name="168"><span class="lineNum">     168 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="169"><span class="lineNum">     169 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 (list true true true true true true true true) { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="170"><span class="lineNum">     170 </span>                :            : </a>
<a name="171"><span class="lineNum">     171 </span>                :            : ;; Read 4 bytes from data, starting at index.  Return the 4-byte slice.</a>
<a name="172"><span class="lineNum">     172 </span>                :            : (define-read-only (read-slice-4 (input { data: (buff 1024), index: uint }))</a>
<a name="173"><span class="lineNum">     173 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="174"><span class="lineNum">     174 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 (list true true true true) { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="175"><span class="lineNum">     175 </span>                :            : </a>
<a name="176"><span class="lineNum">     176 </span>                :            : ;; Read 2 bytes from data, starting at index.  Return the 2-byte slice.</a>
<a name="177"><span class="lineNum">     177 </span>                :            : (define-read-only (read-slice-2 (input { data: (buff 1024), index: uint }))</a>
<a name="178"><span class="lineNum">     178 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="179"><span class="lineNum">     179 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 (list true true) { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="180"><span class="lineNum">     180 </span>                :            : </a>
<a name="181"><span class="lineNum">     181 </span>                :            : ;; Read 1 byte from data, starting at index.  Return the 1-byte slice.</a>
<a name="182"><span class="lineNum">     182 </span>                :            : (define-read-only (read-slice-1 (input { data: (buff 1024), index: uint }))</a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineNoCov">          0 :     (get acc</span></a>
<a name="184"><span class="lineNum">     184 </span>                :<span class="lineNoCov">          0 :         (fold inner-read-slice-1024 (list true) { acc: 0x, data: (get data input), index: (get index input) })))</span></a>
<a name="185"><span class="lineNum">     185 </span>                :            : </a>
<a name="186"><span class="lineNum">     186 </span>                :            : ;; Read a fixed-sized chunk of data from a given buffer (up to remaining bytes), starting at index, and append it to acc.</a>
<a name="187"><span class="lineNum">     187 </span>                :            : ;; chunk_size must be a power of 2, up to 1024</a>
<a name="188"><span class="lineNum">     188 </span>                :            : (define-read-only (inner-read-slice (chunk_size uint) (input { acc: (buff 1024), buffer: (buff 1024), index: uint, remaining: uint }))</a>
<a name="189"><span class="lineNum">     189 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="190"><span class="lineNum">     190 </span>                :<span class="lineNoCov">          0 :         (ctr (get index input))</span></a>
<a name="191"><span class="lineNum">     191 </span>                :<span class="lineNoCov">          0 :         (remaining (get remaining input))</span></a>
<a name="192"><span class="lineNum">     192 </span>                :            :     )</a>
<a name="193"><span class="lineNum">     193 </span>                :<span class="lineNoCov">          0 :     (if (is-eq u0 remaining)</span></a>
<a name="194"><span class="lineNum">     194 </span>                :            :         ;; done reading</a>
<a name="195"><span class="lineNum">     195 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         input</span></a>
<a name="196"><span class="lineNum">     196 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (let (</span></a>
<a name="197"><span class="lineNum">     197 </span>                :<span class="lineNoCov">          0 :             (acc (get acc input))</span></a>
<a name="198"><span class="lineNum">     198 </span>                :<span class="lineNoCov">          0 :             (databuff (get buffer input))</span></a>
<a name="199"><span class="lineNum">     199 </span>                :            :         )</a>
<a name="200"><span class="lineNum">     200 </span>                :<span class="lineNoCov">          0 :         (if (&gt; chunk_size remaining)</span></a>
<a name="201"><span class="lineNum">     201 </span>                :            :             ;; chunk size too big for remainder, so just skip it.</a>
<a name="202"><span class="lineNum">     202 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :             input</span></a>
<a name="203"><span class="lineNum">     203 </span>                :            :             ;; we have at least chunk_size bytes to read!</a>
<a name="204"><span class="lineNum">     204 </span>                :            :             ;; dispatch to the right fixed-size slice reader.</a>
<a name="205"><span class="lineNum">     205 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u512)</span></a>
<a name="206"><span class="lineNum">     206 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-512 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="207"><span class="lineNum">     207 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u256)</span></a>
<a name="208"><span class="lineNum">     208 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-256 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="209"><span class="lineNum">     209 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u128)</span></a>
<a name="210"><span class="lineNum">     210 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-128 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="211"><span class="lineNum">     211 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u64)</span></a>
<a name="212"><span class="lineNum">     212 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-64 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="213"><span class="lineNum">     213 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u32)</span></a>
<a name="214"><span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-32 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="215"><span class="lineNum">     215 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u16)</span></a>
<a name="216"><span class="lineNum">     216 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-16 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="217"><span class="lineNum">     217 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u8)</span></a>
<a name="218"><span class="lineNum">     218 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-8 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="219"><span class="lineNum">     219 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u4)</span></a>
<a name="220"><span class="lineNum">     220 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-4 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="221"><span class="lineNum">     221 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u2)</span></a>
<a name="222"><span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-2 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="223"><span class="lineNum">     223 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq chunk_size u1)</span></a>
<a name="224"><span class="lineNum">     224 </span>                :<span class="lineNoCov">          0 :                 { acc: (unwrap-panic (as-max-len? (concat acc (read-slice-1 { data: databuff, index: ctr })) u1024)), buffer: databuff, index: (+ chunk_size ctr), remaining: (- remaining chunk_size) }</span></a>
<a name="225"><span class="lineNum">     225 </span>                :<span class="lineNoCov">          0 :                 { acc: acc, buffer: databuff, index: ctr, remaining: remaining }</span></a>
<a name="226"><span class="lineNum">     226 </span>                :            :             ))))))))))</a>
<a name="227"><span class="lineNum">     227 </span>                :            :         ))</a>
<a name="228"><span class="lineNum">     228 </span>                :            :     ))</a>
<a name="229"><span class="lineNum">     229 </span>                :            : )</a>
<a name="230"><span class="lineNum">     230 </span>                :            : </a>
<a name="231"><span class="lineNum">     231 </span>                :            : ;; Top-level function to read a slice of a given size from a given (buff 1024), starting at a given offset.</a>
<a name="232"><span class="lineNum">     232 </span>                :            : ;; Returns (ok (buff 1024)) on success, and it contains &quot;buff[offset..(offset+size)]&quot;</a>
<a name="233"><span class="lineNum">     233 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if the slice offset and/or size would copy a range of bytes outside the given buffer.</a>
<a name="234"><span class="lineNum">     234 </span>                :            : (define-read-only (read-slice (data (buff 1024)) (offset uint) (size uint))</a>
<a name="235"><span class="lineNum">     235 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :     (if (or (&gt;= offset (len data)) (&gt; (+ offset size) (len data)))</span></a>
<a name="236"><span class="lineNum">     236 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (err ERR-OUT-OF-BOUNDS)</span></a>
<a name="237"><span class="lineNum">     237 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (begin</span></a>
<a name="238"><span class="lineNum">     238 </span>                :            :         ;;    (print &quot;read slice&quot;)</a>
<a name="239"><span class="lineNum">     239 </span>                :            :         ;;    (print size)</a>
<a name="240"><span class="lineNum">     240 </span>                :<span class="lineNoCov">          0 :            (ok</span></a>
<a name="241"><span class="lineNum">     241 </span>                :<span class="lineNoCov">          0 :              (get acc</span></a>
<a name="242"><span class="lineNum">     242 </span>                :<span class="lineNoCov">          0 :                  (fold inner-read-slice (list u512 u256 u128 u64 u32 u16 u8 u4 u2 u1) { acc: 0x, buffer: data, index: offset, remaining: size }))</span></a>
<a name="243"><span class="lineNum">     243 </span>                :            :            )</a>
<a name="244"><span class="lineNum">     244 </span>                :            :         )</a>
<a name="245"><span class="lineNum">     245 </span>                :            :     )</a>
<a name="246"><span class="lineNum">     246 </span>                :            : )</a>
<a name="247"><span class="lineNum">     247 </span>                :            : </a>
<a name="248"><span class="lineNum">     248 </span>                :            : ;; Reads the next two bytes from txbuff as a big-endian 16-bit integer, and updates the index.</a>
<a name="249"><span class="lineNum">     249 </span>                :            : ;; Returns (ok { uint16: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success.</a>
<a name="250"><span class="lineNum">     250 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff</a>
<a name="251"><span class="lineNum">     251 </span>                :            : (define-read-only (read-uint16 (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="252"><span class="lineNum">     252 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="253"><span class="lineNum">     253 </span>                :<span class="lineNoCov">          0 :         (data (get txbuff ctx))</span></a>
<a name="254"><span class="lineNum">     254 </span>                :<span class="lineNoCov">          0 :         (base (get index ctx))</span></a>
<a name="255"><span class="lineNum">     255 </span>                :<span class="lineNoCov">          0 :         (byte-1 (buff-to-u8 (unwrap! (element-at data base) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="256"><span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 :         (byte-2 (buff-to-u8 (unwrap! (element-at data (+ u1 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="257"><span class="lineNum">     257 </span>                :<span class="lineNoCov">          0 :         (ret (+ (* byte-2 u256) byte-1))</span></a>
<a name="258"><span class="lineNum">     258 </span>                :            :     )</a>
<a name="259"><span class="lineNum">     259 </span>                :<span class="lineNoCov">          0 :     (begin</span></a>
<a name="260"><span class="lineNum">     260 </span>                :            :     ;;    (print &quot;read uint16&quot;)</a>
<a name="261"><span class="lineNum">     261 </span>                :            :     ;;    (print ret)</a>
<a name="262"><span class="lineNum">     262 </span>                :<span class="lineNoCov">          0 :        (ok {</span></a>
<a name="263"><span class="lineNum">     263 </span>                :<span class="lineNoCov">          0 :            uint16: ret,</span></a>
<a name="264"><span class="lineNum">     264 </span>                :<span class="lineNoCov">          0 :            ctx: { txbuff: data, index: (+ u2 base) }</span></a>
<a name="265"><span class="lineNum">     265 </span>                :            :        })</a>
<a name="266"><span class="lineNum">     266 </span>                :            :     ))</a>
<a name="267"><span class="lineNum">     267 </span>                :            : )</a>
<a name="268"><span class="lineNum">     268 </span>                :            : </a>
<a name="269"><span class="lineNum">     269 </span>                :            : ;; Reads the next four bytes from txbuff as a big-endian 32-bit integer, and updates the index.</a>
<a name="270"><span class="lineNum">     270 </span>                :            : ;; Returns (ok { uint32: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success.</a>
<a name="271"><span class="lineNum">     271 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff</a>
<a name="272"><span class="lineNum">     272 </span>                :            : (define-read-only (read-uint32 (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="273"><span class="lineNum">     273 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="274"><span class="lineNum">     274 </span>                :<span class="lineNoCov">          0 :         (data (get txbuff ctx))</span></a>
<a name="275"><span class="lineNum">     275 </span>                :<span class="lineNoCov">          0 :         (base (get index ctx))</span></a>
<a name="276"><span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 :         (byte-1 (buff-to-u8 (unwrap! (element-at data base) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="277"><span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :         (byte-2 (buff-to-u8 (unwrap! (element-at data (+ u1 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="278"><span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :         (byte-3 (buff-to-u8 (unwrap! (element-at data (+ u2 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="279"><span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :         (byte-4 (buff-to-u8 (unwrap! (element-at data (+ u3 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="280"><span class="lineNum">     280 </span>                :<span class="lineNoCov">          0 :         (ret (+ (* byte-4 u16777216) (* byte-3 u65536) (* byte-2 u256) byte-1))</span></a>
<a name="281"><span class="lineNum">     281 </span>                :            :     )</a>
<a name="282"><span class="lineNum">     282 </span>                :<span class="lineNoCov">          0 :     (begin</span></a>
<a name="283"><span class="lineNum">     283 </span>                :            :     ;;    (print &quot;read uint32&quot;)</a>
<a name="284"><span class="lineNum">     284 </span>                :            :     ;;    (print ret)</a>
<a name="285"><span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :        (ok {</span></a>
<a name="286"><span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 :            uint32: ret,</span></a>
<a name="287"><span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :            ctx: { txbuff: data, index: (+ u4 base) }</span></a>
<a name="288"><span class="lineNum">     288 </span>                :            :        })</a>
<a name="289"><span class="lineNum">     289 </span>                :            :     ))</a>
<a name="290"><span class="lineNum">     290 </span>                :            : )</a>
<a name="291"><span class="lineNum">     291 </span>                :            : </a>
<a name="292"><span class="lineNum">     292 </span>                :            : ;; Reads the next eight bytes from txbuff as a big-endian 64-bit integer, and updates the index.</a>
<a name="293"><span class="lineNum">     293 </span>                :            : ;; Returns (ok { uint64: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success.</a>
<a name="294"><span class="lineNum">     294 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff</a>
<a name="295"><span class="lineNum">     295 </span>                :            : (define-read-only (read-uint64 (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="296"><span class="lineNum">     296 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="297"><span class="lineNum">     297 </span>                :<span class="lineNoCov">          0 :         (data (get txbuff ctx))</span></a>
<a name="298"><span class="lineNum">     298 </span>                :<span class="lineNoCov">          0 :         (base (get index ctx))</span></a>
<a name="299"><span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :         (byte-1 (buff-to-u8 (unwrap! (element-at data base) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="300"><span class="lineNum">     300 </span>                :<span class="lineNoCov">          0 :         (byte-2 (buff-to-u8 (unwrap! (element-at data (+ u1 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="301"><span class="lineNum">     301 </span>                :<span class="lineNoCov">          0 :         (byte-3 (buff-to-u8 (unwrap! (element-at data (+ u2 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="302"><span class="lineNum">     302 </span>                :<span class="lineNoCov">          0 :         (byte-4 (buff-to-u8 (unwrap! (element-at data (+ u3 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="303"><span class="lineNum">     303 </span>                :<span class="lineNoCov">          0 :         (byte-5 (buff-to-u8 (unwrap! (element-at data (+ u4 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="304"><span class="lineNum">     304 </span>                :<span class="lineNoCov">          0 :         (byte-6 (buff-to-u8 (unwrap! (element-at data (+ u5 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="305"><span class="lineNum">     305 </span>                :<span class="lineNoCov">          0 :         (byte-7 (buff-to-u8 (unwrap! (element-at data (+ u6 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="306"><span class="lineNum">     306 </span>                :<span class="lineNoCov">          0 :         (byte-8 (buff-to-u8 (unwrap! (element-at data (+ u7 base)) (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="307"><span class="lineNum">     307 </span>                :<span class="lineNoCov">          0 :         (ret (+ </span></a>
<a name="308"><span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :            (* byte-8 u72057594037927936)</span></a>
<a name="309"><span class="lineNum">     309 </span>                :<span class="lineNoCov">          0 :            (* byte-7 u281474976710656)</span></a>
<a name="310"><span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 :            (* byte-6 u1099511627776)</span></a>
<a name="311"><span class="lineNum">     311 </span>                :<span class="lineNoCov">          0 :            (* byte-5 u4294967296)</span></a>
<a name="312"><span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 :            (* byte-4 u16777216)</span></a>
<a name="313"><span class="lineNum">     313 </span>                :<span class="lineNoCov">          0 :            (* byte-3 u65536)</span></a>
<a name="314"><span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :            (* byte-2 u256)</span></a>
<a name="315"><span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :            byte-1))</span></a>
<a name="316"><span class="lineNum">     316 </span>                :            :     )</a>
<a name="317"><span class="lineNum">     317 </span>                :<span class="lineNoCov">          0 :     (begin</span></a>
<a name="318"><span class="lineNum">     318 </span>                :            :     ;;    (print &quot;read uint64&quot;)</a>
<a name="319"><span class="lineNum">     319 </span>                :            :     ;;    (print ret)</a>
<a name="320"><span class="lineNum">     320 </span>                :<span class="lineNoCov">          0 :        (ok {</span></a>
<a name="321"><span class="lineNum">     321 </span>                :<span class="lineNoCov">          0 :            uint64: ret,</span></a>
<a name="322"><span class="lineNum">     322 </span>                :<span class="lineNoCov">          0 :            ctx: { txbuff: data, index: (+ u8 base) }</span></a>
<a name="323"><span class="lineNum">     323 </span>                :            :        })</a>
<a name="324"><span class="lineNum">     324 </span>                :            :     ))</a>
<a name="325"><span class="lineNum">     325 </span>                :            : )</a>
<a name="326"><span class="lineNum">     326 </span>                :            : </a>
<a name="327"><span class="lineNum">     327 </span>                :            : ;; Reads the next varint from txbuff, and updates the index.</a>
<a name="328"><span class="lineNum">     328 </span>                :            : ;; Returns (ok { varint: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success</a>
<a name="329"><span class="lineNum">     329 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="330"><span class="lineNum">     330 </span>                :            : (define-read-only (read-varint (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="331"><span class="lineNum">     331 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="332"><span class="lineNum">     332 </span>                :<span class="lineNoCov">          0 :         (ptr (get index ctx))</span></a>
<a name="333"><span class="lineNum">     333 </span>                :<span class="lineNoCov">          0 :         (tx (get txbuff ctx))</span></a>
<a name="334"><span class="lineNum">     334 </span>                :<span class="lineNoCov">          0 :         (byte (buff-to-u8 (unwrap! (element-at tx ptr)</span></a>
<a name="335"><span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :                             (err ERR-OUT-OF-BOUNDS))))</span></a>
<a name="336"><span class="lineNum">     336 </span>                :            :     )</a>
<a name="337"><span class="lineNum">     337 </span>                :<span class="lineNoCov">          0 :     (if (&lt;= byte u252)</span></a>
<a name="338"><span class="lineNum">     338 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (begin</span></a>
<a name="339"><span class="lineNum">     339 </span>                :            :         ;;    (print &quot;varint 1&quot;)</a>
<a name="340"><span class="lineNum">     340 </span>                :            :         ;;    (print byte)</a>
<a name="341"><span class="lineNum">     341 </span>                :            :            ;; given byte is the varint</a>
<a name="342"><span class="lineNum">     342 </span>                :<span class="lineNoCov">          0 :            (ok { varint: byte, ctx: { txbuff: tx, index: (+ u1 ptr) }})</span></a>
<a name="343"><span class="lineNum">     343 </span>                :            :         )</a>
<a name="344"><span class="lineNum">     344 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (if (is-eq byte u253)</span></a>
<a name="345"><span class="lineNum">     345 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (let (</span></a>
<a name="346"><span class="lineNum">     346 </span>                :            :                 ;; next two bytes is the varint</a>
<a name="347"><span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 :                 (parsed-u16 (try! (read-uint16 { txbuff: tx, index: (+ u1 ptr) })))</span></a>
<a name="348"><span class="lineNum">     348 </span>                :            :             )</a>
<a name="349"><span class="lineNum">     349 </span>                :<span class="lineNoCov">          0 :             (begin</span></a>
<a name="350"><span class="lineNum">     350 </span>                :            :                 ;; (print &quot;varint 2&quot;)</a>
<a name="351"><span class="lineNum">     351 </span>                :            :                 ;; (print (get uint16 parsed-u16))</a>
<a name="352"><span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 :                 (ok { varint: (get uint16 parsed-u16), ctx: (get ctx parsed-u16) })</span></a>
<a name="353"><span class="lineNum">     353 </span>                :            :             ))</a>
<a name="354"><span class="lineNum">     354 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (is-eq byte u254)</span></a>
<a name="355"><span class="lineNum">     355 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (let (</span></a>
<a name="356"><span class="lineNum">     356 </span>                :            :                     ;; next four bytes is the varint</a>
<a name="357"><span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :                     (parsed-u32 (try! (read-uint32 { txbuff: tx, index: (+ u1 ptr) })))</span></a>
<a name="358"><span class="lineNum">     358 </span>                :            :                 )</a>
<a name="359"><span class="lineNum">     359 </span>                :<span class="lineNoCov">          0 :                 (begin</span></a>
<a name="360"><span class="lineNum">     360 </span>                :            :                     ;; (print &quot;varint 4&quot;)</a>
<a name="361"><span class="lineNum">     361 </span>                :            :                     ;; (print (get uint32 parsed-u32))</a>
<a name="362"><span class="lineNum">     362 </span>                :<span class="lineNoCov">          0 :                     (ok { varint: (get uint32 parsed-u32), ctx: (get ctx parsed-u32) })</span></a>
<a name="363"><span class="lineNum">     363 </span>                :            :                 ))</a>
<a name="364"><span class="lineNum">     364 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (let (</span></a>
<a name="365"><span class="lineNum">     365 </span>                :            :                     ;; next eight bytes is the varint</a>
<a name="366"><span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :                     (parsed-u64 (try! (read-uint64 { txbuff: tx, index: (+ u1 ptr) })))</span></a>
<a name="367"><span class="lineNum">     367 </span>                :            :                 )</a>
<a name="368"><span class="lineNum">     368 </span>                :<span class="lineNoCov">          0 :                 (begin</span></a>
<a name="369"><span class="lineNum">     369 </span>                :            :                     ;; (print &quot;varint 8&quot;)</a>
<a name="370"><span class="lineNum">     370 </span>                :            :                     ;; (print (get uint64 parsed-u64))</a>
<a name="371"><span class="lineNum">     371 </span>                :<span class="lineNoCov">          0 :                     (ok { varint: (get uint64 parsed-u64), ctx: (get ctx parsed-u64) })</span></a>
<a name="372"><span class="lineNum">     372 </span>                :            :                 ))</a>
<a name="373"><span class="lineNum">     373 </span>                :            :             )</a>
<a name="374"><span class="lineNum">     374 </span>                :            :         )</a>
<a name="375"><span class="lineNum">     375 </span>                :            :     ))</a>
<a name="376"><span class="lineNum">     376 </span>                :            : )</a>
<a name="377"><span class="lineNum">     377 </span>                :            : </a>
<a name="378"><span class="lineNum">     378 </span>                :            : ;; Reads a varint-prefixed byte slice from txbuff, and updates the index to point to the byte after the varint and slice.</a>
<a name="379"><span class="lineNum">     379 </span>                :            : ;; Returns (ok { varslice: (buff 1024), ctx: { txbuff: (buff 1024), index: uint } }) on success, where varslice has the length of the varint prefix.</a>
<a name="380"><span class="lineNum">     380 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="381"><span class="lineNum">     381 </span>                :            : (define-read-only (read-varslice (old-ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="382"><span class="lineNum">     382 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="383"><span class="lineNum">     383 </span>                :<span class="lineNoCov">          0 :         (parsed (try! (read-varint old-ctx)))</span></a>
<a name="384"><span class="lineNum">     384 </span>                :<span class="lineNoCov">          0 :         (slice-len (get varint parsed))</span></a>
<a name="385"><span class="lineNum">     385 </span>                :<span class="lineNoCov">          0 :         (ctx (get ctx parsed))</span></a>
<a name="386"><span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :         (slice-2 (try! (read-slice (get txbuff ctx) (get index ctx) slice-len)))</span></a>
<a name="387"><span class="lineNum">     387 </span>                :            :     )</a>
<a name="388"><span class="lineNum">     388 </span>                :<span class="lineNoCov">          0 :     (ok {</span></a>
<a name="389"><span class="lineNum">     389 </span>                :<span class="lineNoCov">          0 :         varslice: slice-2,</span></a>
<a name="390"><span class="lineNum">     390 </span>                :<span class="lineNoCov">          0 :         ctx: { txbuff: (get txbuff ctx), index: (+ (len slice-2) (get index ctx)) }</span></a>
<a name="391"><span class="lineNum">     391 </span>                :            :     }))</a>
<a name="392"><span class="lineNum">     392 </span>                :            : )</a>
<a name="393"><span class="lineNum">     393 </span>                :            : </a>
<a name="394"><span class="lineNum">     394 </span>                :            : ;; Generate a permutation of a given 32-byte buffer, appending the element at target-index to hash-output.</a>
<a name="395"><span class="lineNum">     395 </span>                :            : ;; The target-index decides which index in hash-input gets appended to hash-output.</a>
<a name="396"><span class="lineNum">     396 </span>                :            : (define-read-only (inner-buff32-permutation (target-index uint) (state { hash-input: (buff 32), hash-output: (buff 32) }))</a>
<a name="397"><span class="lineNum">     397 </span>                :            :     {</a>
<a name="398"><span class="lineNum">     398 </span>                :<span class="lineNoCov">          0 :         hash-input: (get hash-input state),</span></a>
<a name="399"><span class="lineNum">     399 </span>                :<span class="lineNoCov">          0 :         hash-output: (unwrap-panic</span></a>
<a name="400"><span class="lineNum">     400 </span>                :<span class="lineNoCov">          0 :             (as-max-len? (concat</span></a>
<a name="401"><span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :                 (get hash-output state)</span></a>
<a name="402"><span class="lineNum">     402 </span>                :<span class="lineNoCov">          0 :                 (unwrap-panic</span></a>
<a name="403"><span class="lineNum">     403 </span>                :<span class="lineNoCov">          0 :                     (as-max-len?</span></a>
<a name="404"><span class="lineNum">     404 </span>                :<span class="lineNoCov">          0 :                         (unwrap-panic</span></a>
<a name="405"><span class="lineNum">     405 </span>                :<span class="lineNoCov">          0 :                             (element-at (get hash-input state) target-index))</span></a>
<a name="406"><span class="lineNum">     406 </span>                :<span class="lineNoCov">          0 :                     u32)))</span></a>
<a name="407"><span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :             u32))</span></a>
<a name="408"><span class="lineNum">     408 </span>                :            :     }</a>
<a name="409"><span class="lineNum">     409 </span>                :            : )</a>
<a name="410"><span class="lineNum">     410 </span>                :            : </a>
<a name="411"><span class="lineNum">     411 </span>                :            : ;; Reverse the byte order of a 32-byte buffer.  Returns the (buff 32).</a>
<a name="412"><span class="lineNum">     412 </span>                :            : (define-read-only (reverse-buff32 (input (buff 32)))</a>
<a name="413"><span class="lineNum">     413 </span>                :<span class="lineNoCov">          0 :     (get hash-output</span></a>
<a name="414"><span class="lineNum">     414 </span>                :<span class="lineNoCov">          0 :          (fold inner-buff32-permutation</span></a>
<a name="415"><span class="lineNum">     415 </span>                :<span class="lineNoCov">          0 :              (list u31 u30 u29 u28 u27 u26 u25 u24 u23 u22 u21 u20 u19 u18 u17 u16 u15 u14 u13 u12 u11 u10 u9 u8 u7 u6 u5 u4 u3 u2 u1 u0)</span></a>
<a name="416"><span class="lineNum">     416 </span>                :<span class="lineNoCov">          0 :              { hash-input: input, hash-output: 0x }))</span></a>
<a name="417"><span class="lineNum">     417 </span>                :            : )</a>
<a name="418"><span class="lineNum">     418 </span>                :            : </a>
<a name="419"><span class="lineNum">     419 </span>                :            : ;; Reads a big-endian hash -- consume the next 32 bytes, and reverse them.</a>
<a name="420"><span class="lineNum">     420 </span>                :            : ;; Returns (ok { hashslice: (buff 32), ctx: { txbuff: (buff 1024), index: uint } }) on success, and updates the index.</a>
<a name="421"><span class="lineNum">     421 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="422"><span class="lineNum">     422 </span>                :            : (define-read-only (read-hashslice (old-ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="423"><span class="lineNum">     423 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="424"><span class="lineNum">     424 </span>                :<span class="lineNoCov">          0 :         (hash-le (unwrap-panic</span></a>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineNoCov">          0 :                     (as-max-len? (try!</span></a>
<a name="426"><span class="lineNum">     426 </span>                :<span class="lineNoCov">          0 :                                     (read-slice (get txbuff old-ctx) (get index old-ctx) u32))</span></a>
<a name="427"><span class="lineNum">     427 </span>                :<span class="lineNoCov">          0 :                     u32)))</span></a>
<a name="428"><span class="lineNum">     428 </span>                :            :     )</a>
<a name="429"><span class="lineNum">     429 </span>                :<span class="lineNoCov">          0 :     (ok {</span></a>
<a name="430"><span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :         hashslice: (reverse-buff32 hash-le),</span></a>
<a name="431"><span class="lineNum">     431 </span>                :<span class="lineNoCov">          0 :         ctx: { txbuff: (get txbuff old-ctx), index: (+ u32 (get index old-ctx)) }</span></a>
<a name="432"><span class="lineNum">     432 </span>                :            :     }))</a>
<a name="433"><span class="lineNum">     433 </span>                :            : )</a>
<a name="434"><span class="lineNum">     434 </span>                :            : </a>
<a name="435"><span class="lineNum">     435 </span>                :            : ;; Inner fold method to read the next tx input from txbuff. </a>
<a name="436"><span class="lineNum">     436 </span>                :            : ;; The index in ctx will be updated to point to the next tx input if all goes well (or to the start of the outputs)</a>
<a name="437"><span class="lineNum">     437 </span>                :            : ;; Returns (ok { ... }) on success.</a>
<a name="438"><span class="lineNum">     438 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="439"><span class="lineNum">     439 </span>                :            : ;; Returns (err ERR-VARSLICE-TOO-LONG) if we find a scriptSig that's too long to parse.</a>
<a name="440"><span class="lineNum">     440 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXINS) if there are more than eight inputs to read.</a>
<a name="441"><span class="lineNum">     441 </span>                :            : (define-read-only (read-next-txin (ignored bool)</a>
<a name="442"><span class="lineNum">     442 </span>                :            :                                   (state-res (response {</a>
<a name="443"><span class="lineNum">     443 </span>                :            :                                     ctx: { txbuff: (buff 1024), index: uint },</a>
<a name="444"><span class="lineNum">     444 </span>                :            :                                     remaining: uint,</a>
<a name="445"><span class="lineNum">     445 </span>                :            :                                     txins: (list 8 {</a>
<a name="446"><span class="lineNum">     446 </span>                :            :                                         outpoint: {</a>
<a name="447"><span class="lineNum">     447 </span>                :            :                                             hash: (buff 32),</a>
<a name="448"><span class="lineNum">     448 </span>                :            :                                             index: uint</a>
<a name="449"><span class="lineNum">     449 </span>                :            :                                         },</a>
<a name="450"><span class="lineNum">     450 </span>                :            :                                         scriptSig: (buff 256),      ;; just big enough to hold a 2-of-3 multisig script</a>
<a name="451"><span class="lineNum">     451 </span>                :            :                                         sequence: uint</a>
<a name="452"><span class="lineNum">     452 </span>                :            :                                     })</a>
<a name="453"><span class="lineNum">     453 </span>                :            :                                   } uint)))</a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :     (match state-res</span></a>
<a name="455"><span class="lineNum">     455 </span>                :            :         state</a>
<a name="456"><span class="lineNum">     456 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (&lt; u0 (get remaining state))</span></a>
<a name="457"><span class="lineNum">     457 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (let (</span></a>
<a name="458"><span class="lineNum">     458 </span>                :<span class="lineNoCov">          0 :                    (remaining (get remaining state))</span></a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineNoCov">          0 :                    (ctx (get ctx state))</span></a>
<a name="460"><span class="lineNum">     460 </span>                :<span class="lineNoCov">          0 :                    (parsed-hash (try! (read-hashslice ctx)))</span></a>
<a name="461"><span class="lineNum">     461 </span>                :<span class="lineNoCov">          0 :                    (parsed-index (try! (read-uint32 (get ctx parsed-hash))))</span></a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineNoCov">          0 :                    (parsed-scriptSig (try! (read-varslice (get ctx parsed-index))))</span></a>
<a name="463"><span class="lineNum">     463 </span>                :<span class="lineNoCov">          0 :                    (parsed-sequence (try! (read-uint32 (get ctx parsed-scriptSig))))</span></a>
<a name="464"><span class="lineNum">     464 </span>                :<span class="lineNoCov">          0 :                    (new-ctx (get ctx parsed-sequence))</span></a>
<a name="465"><span class="lineNum">     465 </span>                :            :                 )</a>
<a name="466"><span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :                 (ok {</span></a>
<a name="467"><span class="lineNum">     467 </span>                :<span class="lineNoCov">          0 :                    ctx: new-ctx,</span></a>
<a name="468"><span class="lineNum">     468 </span>                :<span class="lineNoCov">          0 :                    remaining: (- remaining u1),</span></a>
<a name="469"><span class="lineNum">     469 </span>                :<span class="lineNoCov">          0 :                    txins: (unwrap!</span></a>
<a name="470"><span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :                      (as-max-len?</span></a>
<a name="471"><span class="lineNum">     471 </span>                :<span class="lineNoCov">          0 :                          (append (get txins state)</span></a>
<a name="472"><span class="lineNum">     472 </span>                :            :                              {</a>
<a name="473"><span class="lineNum">     473 </span>                :<span class="lineNoCov">          0 :                                  outpoint: {</span></a>
<a name="474"><span class="lineNum">     474 </span>                :<span class="lineNoCov">          0 :                                     hash: (get hashslice parsed-hash),</span></a>
<a name="475"><span class="lineNum">     475 </span>                :<span class="lineNoCov">          0 :                                     index: (get uint32 parsed-index)</span></a>
<a name="476"><span class="lineNum">     476 </span>                :            :                                  },</a>
<a name="477"><span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :                                  scriptSig: (unwrap! (as-max-len? (get varslice parsed-scriptSig) u256) (err ERR-VARSLICE-TOO-LONG)),</span></a>
<a name="478"><span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 :                                  sequence: (get uint32 parsed-sequence)</span></a>
<a name="479"><span class="lineNum">     479 </span>                :            :                              })</a>
<a name="480"><span class="lineNum">     480 </span>                :<span class="lineNoCov">          0 :                      u8)</span></a>
<a name="481"><span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :                      (err ERR-TOO-MANY-TXINS))</span></a>
<a name="482"><span class="lineNum">     482 </span>                :            :                 }))</a>
<a name="483"><span class="lineNum">     483 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (ok state)</span></a>
<a name="484"><span class="lineNum">     484 </span>                :            :             )</a>
<a name="485"><span class="lineNum">     485 </span>                :            :         error</a>
<a name="486"><span class="lineNum">     486 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (err error)</span></a>
<a name="487"><span class="lineNum">     487 </span>                :            :     )</a>
<a name="488"><span class="lineNum">     488 </span>                :            : )</a>
<a name="489"><span class="lineNum">     489 </span>                :            : </a>
<a name="490"><span class="lineNum">     490 </span>                :            : ;; Read a transaction's inputs.</a>
<a name="491"><span class="lineNum">     491 </span>                :            : ;; Returns (ok { txins: (list { ... }), remaining: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success, and updates the index in ctx to point to the start of the tx outputs.</a>
<a name="492"><span class="lineNum">     492 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="493"><span class="lineNum">     493 </span>                :            : ;; Returns (err ERR-VARSLICE-TOO-LONG) if we find a scriptSig that's too long to parse.</a>
<a name="494"><span class="lineNum">     494 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXINS) if there are more than eight inputs to read.</a>
<a name="495"><span class="lineNum">     495 </span>                :            : (define-read-only (read-txins (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="496"><span class="lineNum">     496 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="497"><span class="lineNum">     497 </span>                :<span class="lineNoCov">          0 :         (parsed-num-txins (try! (read-varint ctx)))</span></a>
<a name="498"><span class="lineNum">     498 </span>                :<span class="lineNoCov">          0 :         (num-txins (get varint parsed-num-txins))</span></a>
<a name="499"><span class="lineNum">     499 </span>                :<span class="lineNoCov">          0 :         (new-ctx (get ctx parsed-num-txins))</span></a>
<a name="500"><span class="lineNum">     500 </span>                :            :     )</a>
<a name="501"><span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :     (if (&gt; num-txins u8)</span></a>
<a name="502"><span class="lineNum">     502 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (err ERR-TOO-MANY-TXINS)</span></a>
<a name="503"><span class="lineNum">     503 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (fold read-next-txin (list true true true true true true true true) (ok { ctx: new-ctx, remaining: num-txins, txins: (list ) }))</span></a>
<a name="504"><span class="lineNum">     504 </span>                :            :     ))</a>
<a name="505"><span class="lineNum">     505 </span>                :            : )</a>
<a name="506"><span class="lineNum">     506 </span>                :            : </a>
<a name="507"><span class="lineNum">     507 </span>                :            : ;; Read the next transaction output, and update the index in ctx to point to the next output.</a>
<a name="508"><span class="lineNum">     508 </span>                :            : ;; Returns (ok { ... }) on success</a>
<a name="509"><span class="lineNum">     509 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="510"><span class="lineNum">     510 </span>                :            : ;; Returns (err ERR-VARSLICE-TOO-LONG) if we find a scriptPubKey that's too long to parse.</a>
<a name="511"><span class="lineNum">     511 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXOUTS) if there are more than eight outputs to read.</a>
<a name="512"><span class="lineNum">     512 </span>                :            : (define-read-only (read-next-txout (ignored bool)</a>
<a name="513"><span class="lineNum">     513 </span>                :            :                                    (state-res (response {</a>
<a name="514"><span class="lineNum">     514 </span>                :            :                                     ctx: { txbuff: (buff 1024), index: uint },</a>
<a name="515"><span class="lineNum">     515 </span>                :            :                                     remaining: uint,</a>
<a name="516"><span class="lineNum">     516 </span>                :            :                                     txouts: (list 8 {</a>
<a name="517"><span class="lineNum">     517 </span>                :            :                                         value: uint,</a>
<a name="518"><span class="lineNum">     518 </span>                :            :                                         scriptPubKey: (buff 128)</a>
<a name="519"><span class="lineNum">     519 </span>                :            :                                     })</a>
<a name="520"><span class="lineNum">     520 </span>                :            :                                    } uint)))</a>
<a name="521"><span class="lineNum">     521 </span>                :<span class="lineNoCov">          0 :     (match state-res</span></a>
<a name="522"><span class="lineNum">     522 </span>                :            :         state</a>
<a name="523"><span class="lineNum">     523 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (if (&lt; u0 (get remaining state))</span></a>
<a name="524"><span class="lineNum">     524 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (let (</span></a>
<a name="525"><span class="lineNum">     525 </span>                :<span class="lineNoCov">          0 :                     (remaining (get remaining state))</span></a>
<a name="526"><span class="lineNum">     526 </span>                :<span class="lineNoCov">          0 :                     (parsed-value (try! (read-uint64 (get ctx state))))</span></a>
<a name="527"><span class="lineNum">     527 </span>                :<span class="lineNoCov">          0 :                     (parsed-script (try! (read-varslice (get ctx parsed-value))))</span></a>
<a name="528"><span class="lineNum">     528 </span>                :<span class="lineNoCov">          0 :                     (new-ctx (get ctx parsed-script))</span></a>
<a name="529"><span class="lineNum">     529 </span>                :            :                 )</a>
<a name="530"><span class="lineNum">     530 </span>                :<span class="lineNoCov">          0 :                 (ok {</span></a>
<a name="531"><span class="lineNum">     531 </span>                :<span class="lineNoCov">          0 :                     ctx: new-ctx,</span></a>
<a name="532"><span class="lineNum">     532 </span>                :<span class="lineNoCov">          0 :                     remaining: (- remaining u1),</span></a>
<a name="533"><span class="lineNum">     533 </span>                :<span class="lineNoCov">          0 :                     txouts: (unwrap!</span></a>
<a name="534"><span class="lineNum">     534 </span>                :<span class="lineNoCov">          0 :                         (as-max-len?</span></a>
<a name="535"><span class="lineNum">     535 </span>                :<span class="lineNoCov">          0 :                             (append (get txouts state)</span></a>
<a name="536"><span class="lineNum">     536 </span>                :            :                                 {</a>
<a name="537"><span class="lineNum">     537 </span>                :<span class="lineNoCov">          0 :                                     value: (get uint64 parsed-value),</span></a>
<a name="538"><span class="lineNum">     538 </span>                :<span class="lineNoCov">          0 :                                     scriptPubKey: (unwrap! (as-max-len? (get varslice parsed-script) u128) (err ERR-VARSLICE-TOO-LONG))</span></a>
<a name="539"><span class="lineNum">     539 </span>                :            :                                 })</a>
<a name="540"><span class="lineNum">     540 </span>                :<span class="lineNoCov">          0 :                         u8) </span></a>
<a name="541"><span class="lineNum">     541 </span>                :<span class="lineNoCov">          0 :                         (err ERR-TOO-MANY-TXOUTS))</span></a>
<a name="542"><span class="lineNum">     542 </span>                :            :                 }))</a>
<a name="543"><span class="lineNum">     543 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (ok state)</span></a>
<a name="544"><span class="lineNum">     544 </span>                :            :             )</a>
<a name="545"><span class="lineNum">     545 </span>                :            :         error</a>
<a name="546"><span class="lineNum">     546 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (err error)</span></a>
<a name="547"><span class="lineNum">     547 </span>                :            :     )</a>
<a name="548"><span class="lineNum">     548 </span>                :            : )</a>
<a name="549"><span class="lineNum">     549 </span>                :            : </a>
<a name="550"><span class="lineNum">     550 </span>                :            : ;; Read all transaction outputs in a transaction.  Update the index to point to the first byte after the outputs, if all goes well.</a>
<a name="551"><span class="lineNum">     551 </span>                :            : ;; Returns (ok { txouts: (list { ... }), remaining: uint, ctx: { txbuff: (buff 1024), index: uint } }) on success, and updates the index in ctx to point to the start of the tx outputs.</a>
<a name="552"><span class="lineNum">     552 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="553"><span class="lineNum">     553 </span>                :            : ;; Returns (err ERR-VARSLICE-TOO-LONG) if we find a scriptPubKey that's too long to parse.</a>
<a name="554"><span class="lineNum">     554 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXOUTS) if there are more than eight outputs to read.</a>
<a name="555"><span class="lineNum">     555 </span>                :            : (define-read-only (read-txouts (ctx { txbuff: (buff 1024), index: uint }))</a>
<a name="556"><span class="lineNum">     556 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="557"><span class="lineNum">     557 </span>                :<span class="lineNoCov">          0 :         (parsed-num-txouts (try! (read-varint ctx)))</span></a>
<a name="558"><span class="lineNum">     558 </span>                :<span class="lineNoCov">          0 :         (num-txouts (get varint parsed-num-txouts))</span></a>
<a name="559"><span class="lineNum">     559 </span>                :<span class="lineNoCov">          0 :         (new-ctx (get ctx parsed-num-txouts))</span></a>
<a name="560"><span class="lineNum">     560 </span>                :            :     )</a>
<a name="561"><span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :     (if (&gt; num-txouts u8)</span></a>
<a name="562"><span class="lineNum">     562 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (err ERR-TOO-MANY-TXOUTS)</span></a>
<a name="563"><span class="lineNum">     563 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (fold read-next-txout (list true true true true true true true true) (ok { ctx: new-ctx, remaining: num-txouts, txouts: (list ) }))</span></a>
<a name="564"><span class="lineNum">     564 </span>                :            :     ))</a>
<a name="565"><span class="lineNum">     565 </span>                :            : )</a>
<a name="566"><span class="lineNum">     566 </span>                :            : </a>
<a name="567"><span class="lineNum">     567 </span>                :            : ;; Parse a Bitcoin transaction, with up to 8 inputs and 8 outputs, with scriptSigs of up to 256 bytes each, and with scriptPubKeys up to 128 bytes.</a>
<a name="568"><span class="lineNum">     568 </span>                :            : ;; Returns a tuple structured as follows on success:</a>
<a name="569"><span class="lineNum">     569 </span>                :            : ;; (ok {</a>
<a name="570"><span class="lineNum">     570 </span>                :            : ;;      version: uint,                      ;; tx version</a>
<a name="571"><span class="lineNum">     571 </span>                :            : ;;      ins: (list 8</a>
<a name="572"><span class="lineNum">     572 </span>                :            : ;;          {</a>
<a name="573"><span class="lineNum">     573 </span>                :            : ;;              outpoint: {                 ;; pointer to the utxo this input consumes</a>
<a name="574"><span class="lineNum">     574 </span>                :            : ;;                  hash: (buff 32),</a>
<a name="575"><span class="lineNum">     575 </span>                :            : ;;                  index: uint</a>
<a name="576"><span class="lineNum">     576 </span>                :            : ;;              },</a>
<a name="577"><span class="lineNum">     577 </span>                :            : ;;              scriptSig: (buff 256),      ;; spending condition script</a>
<a name="578"><span class="lineNum">     578 </span>                :            : ;;              sequence: uint</a>
<a name="579"><span class="lineNum">     579 </span>                :            : ;;          }),</a>
<a name="580"><span class="lineNum">     580 </span>                :            : ;;      outs: (list 8</a>
<a name="581"><span class="lineNum">     581 </span>                :            : ;;          {</a>
<a name="582"><span class="lineNum">     582 </span>                :            : ;;              value: uint,                ;; satoshis sent</a>
<a name="583"><span class="lineNum">     583 </span>                :            : ;;              scriptPubKey: (buff 128)    ;; parse this to get an address</a>
<a name="584"><span class="lineNum">     584 </span>                :            : ;;          }),</a>
<a name="585"><span class="lineNum">     585 </span>                :            : ;;      locktime: uint</a>
<a name="586"><span class="lineNum">     586 </span>                :            : ;; })</a>
<a name="587"><span class="lineNum">     587 </span>                :            : ;; Returns (err ERR-OUT-OF-BOUNDS) if we read past the end of txbuff.</a>
<a name="588"><span class="lineNum">     588 </span>                :            : ;; Returns (err ERR-VARSLICE-TOO-LONG) if we find a scriptPubKey or scriptSig that's too long to parse.</a>
<a name="589"><span class="lineNum">     589 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXOUTS) if there are more than eight inputs to read.</a>
<a name="590"><span class="lineNum">     590 </span>                :            : ;; Returns (err ERR-TOO-MANY-TXINS) if there are more than eight outputs to read.</a>
<a name="591"><span class="lineNum">     591 </span>                :            : (define-read-only (parse-tx (tx (buff 1024)))</a>
<a name="592"><span class="lineNum">     592 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="593"><span class="lineNum">     593 </span>                :<span class="lineNoCov">          0 :         (ctx { txbuff: tx, index: u0 })</span></a>
<a name="594"><span class="lineNum">     594 </span>                :<span class="lineNoCov">          0 :         (parsed-version (try! (read-uint32 ctx)))</span></a>
<a name="595"><span class="lineNum">     595 </span>                :<span class="lineNoCov">          0 :         (parsed-txins (try! (read-txins (get ctx parsed-version))))</span></a>
<a name="596"><span class="lineNum">     596 </span>                :<span class="lineNoCov">          0 :         (parsed-txouts (try! (read-txouts (get ctx parsed-txins))))</span></a>
<a name="597"><span class="lineNum">     597 </span>                :<span class="lineNoCov">          0 :         (parsed-locktime (try! (read-uint32 (get ctx parsed-txouts))))</span></a>
<a name="598"><span class="lineNum">     598 </span>                :            :     )</a>
<a name="599"><span class="lineNum">     599 </span>                :<span class="lineNoCov">          0 :     (ok {</span></a>
<a name="600"><span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :         version: (get uint32 parsed-version),</span></a>
<a name="601"><span class="lineNum">     601 </span>                :<span class="lineNoCov">          0 :         ins: (get txins parsed-txins),</span></a>
<a name="602"><span class="lineNum">     602 </span>                :<span class="lineNoCov">          0 :         outs: (get txouts parsed-txouts),</span></a>
<a name="603"><span class="lineNum">     603 </span>                :<span class="lineNoCov">          0 :         locktime: (get uint32 parsed-locktime)</span></a>
<a name="604"><span class="lineNum">     604 </span>                :            :     }))</a>
<a name="605"><span class="lineNum">     605 </span>                :            : )</a>
<a name="606"><span class="lineNum">     606 </span>                :            : </a>
<a name="607"><span class="lineNum">     607 </span>                :            : ;; Parse a Bitcoin block header.</a>
<a name="608"><span class="lineNum">     608 </span>                :            : ;; Returns a tuple structured as folowed on success:</a>
<a name="609"><span class="lineNum">     609 </span>                :            : ;; (ok {</a>
<a name="610"><span class="lineNum">     610 </span>                :            : ;;      version: uint,                  ;; block version,</a>
<a name="611"><span class="lineNum">     611 </span>                :            : ;;      parent: (buff 32),              ;; parent block hash,</a>
<a name="612"><span class="lineNum">     612 </span>                :            : ;;      merkle-root: (buff 32),         ;; merkle root for all this block's transactions</a>
<a name="613"><span class="lineNum">     613 </span>                :            : ;;      timestamp: uint,                ;; UNIX epoch timestamp of this block, in seconds</a>
<a name="614"><span class="lineNum">     614 </span>                :            : ;;      nbits: uint,                    ;; compact block difficulty representation</a>
<a name="615"><span class="lineNum">     615 </span>                :            : ;;      nonce: uint                     ;; PoW solution</a>
<a name="616"><span class="lineNum">     616 </span>                :            : ;; })</a>
<a name="617"><span class="lineNum">     617 </span>                :            : ;; Returns (err ERR-BAD-HEADER) if the header buffer isn't actually 80 bytes long.</a>
<a name="618"><span class="lineNum">     618 </span>                :            : (define-read-only (parse-block-header (headerbuff (buff 80)))</a>
<a name="619"><span class="lineNum">     619 </span>                :<span class="lineNoCov">          0 :     (let (</span></a>
<a name="620"><span class="lineNum">     620 </span>                :<span class="lineNoCov">          0 :         (ctx { txbuff: (unwrap! (as-max-len? headerbuff u1024) (err ERR-BAD-HEADER)), index: u0 })</span></a>
<a name="621"><span class="lineNum">     621 </span>                :            : </a>
<a name="622"><span class="lineNum">     622 </span>                :            :         ;; none of these should fail, since they're all fixed-length fields whose lengths sum to 80</a>
<a name="623"><span class="lineNum">     623 </span>                :<span class="lineNoCov">          0 :         (parsed-version (unwrap-panic (read-uint32 ctx)))</span></a>
<a name="624"><span class="lineNum">     624 </span>                :<span class="lineNoCov">          0 :         (parsed-parent-hash (unwrap-panic (read-hashslice (get ctx parsed-version))))</span></a>
<a name="625"><span class="lineNum">     625 </span>                :<span class="lineNoCov">          0 :         (parsed-merkle-root (unwrap-panic (read-hashslice (get ctx parsed-parent-hash))))</span></a>
<a name="626"><span class="lineNum">     626 </span>                :<span class="lineNoCov">          0 :         (parsed-timestamp (unwrap-panic (read-uint32 (get ctx parsed-merkle-root))))</span></a>
<a name="627"><span class="lineNum">     627 </span>                :<span class="lineNoCov">          0 :         (parsed-nbits (unwrap-panic (read-uint32 (get ctx parsed-timestamp))))</span></a>
<a name="628"><span class="lineNum">     628 </span>                :<span class="lineNoCov">          0 :         (parsed-nonce (unwrap-panic (read-uint32 (get ctx parsed-nbits))))</span></a>
<a name="629"><span class="lineNum">     629 </span>                :            :     )</a>
<a name="630"><span class="lineNum">     630 </span>                :<span class="lineNoCov">          0 :     (ok {</span></a>
<a name="631"><span class="lineNum">     631 </span>                :<span class="lineNoCov">          0 :         version: (get uint32 parsed-version),</span></a>
<a name="632"><span class="lineNum">     632 </span>                :<span class="lineNoCov">          0 :         parent: (get hashslice parsed-parent-hash),</span></a>
<a name="633"><span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :         merkle-root: (get hashslice parsed-merkle-root),</span></a>
<a name="634"><span class="lineNum">     634 </span>                :<span class="lineNoCov">          0 :         timestamp: (get uint32 parsed-timestamp),</span></a>
<a name="635"><span class="lineNum">     635 </span>                :<span class="lineNoCov">          0 :         nbits: (get uint32 parsed-nbits),</span></a>
<a name="636"><span class="lineNum">     636 </span>                :<span class="lineNoCov">          0 :         nonce: (get uint32 parsed-nonce)</span></a>
<a name="637"><span class="lineNum">     637 </span>                :            :     }))</a>
<a name="638"><span class="lineNum">     638 </span>                :            : )</a>
<a name="639"><span class="lineNum">     639 </span>                :            : </a>
<a name="640"><span class="lineNum">     640 </span>                :            : ;; Verify that a block header hashes to a burnchain header hash at a given height.</a>
<a name="641"><span class="lineNum">     641 </span>                :            : ;; Returns true if so; false if not.</a>
<a name="642"><span class="lineNum">     642 </span>                :            : (define-read-only (verify-block-header (headerbuff (buff 80)) (expected-block-height uint))</a>
<a name="643"><span class="lineNum">     643 </span>                :<span class="lineNoCov">          0 :     (match (get-block-info? burnchain-header-hash expected-block-height)</span></a>
<a name="644"><span class="lineNum">     644 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         bhh (is-eq bhh (reverse-buff32 (sha256 (sha256 headerbuff))))</span></a>
<a name="645"><span class="lineNum">     645 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         false</span></a>
<a name="646"><span class="lineNum">     646 </span>                :            :     )</a>
<a name="647"><span class="lineNum">     647 </span>                :            : )</a>
<a name="648"><span class="lineNum">     648 </span>                :            : </a>
<a name="649"><span class="lineNum">     649 </span>                :            : ;; Get the txid of a transaction, but big-endian.</a>
<a name="650"><span class="lineNum">     650 </span>                :            : ;; This is the reverse of what you see on block explorers.</a>
<a name="651"><span class="lineNum">     651 </span>                :            : (define-read-only (get-reversed-txid (tx (buff 1024)))</a>
<a name="652"><span class="lineNum">     652 </span>                :<span class="lineNoCov">          0 :     (sha256 (sha256 tx)))</span></a>
<a name="653"><span class="lineNum">     653 </span>                :            : </a>
<a name="654"><span class="lineNum">     654 </span>                :            : ;; Get the txid of a transaction.</a>
<a name="655"><span class="lineNum">     655 </span>                :            : ;; This is what you see on block explorers.</a>
<a name="656"><span class="lineNum">     656 </span>                :            : (define-read-only (get-txid (tx (buff 1024)))</a>
<a name="657"><span class="lineNum">     657 </span>                :<span class="lineNoCov">          0 :     (reverse-buff32 (get-reversed-txid tx))</span></a>
<a name="658"><span class="lineNum">     658 </span>                :            : )</a>
<a name="659"><span class="lineNum">     659 </span>                :            : </a>
<a name="660"><span class="lineNum">     660 </span>                :            : ;; Determine if the ith bit in a uint is set to 1</a>
<a name="661"><span class="lineNum">     661 </span>                :            : (define-read-only (is-bit-set (val uint) (bit uint))</a>
<a name="662"><span class="lineNum">     662 </span>                :<span class="lineNoCov">          0 :     (is-eq (mod (/ val (pow u2 bit)) u2) u1)</span></a>
<a name="663"><span class="lineNum">     663 </span>                :            : )</a>
<a name="664"><span class="lineNum">     664 </span>                :            : </a>
<a name="665"><span class="lineNum">     665 </span>                :            : ;; Verify the next step of a Merkle proof.</a>
<a name="666"><span class="lineNum">     666 </span>                :            : ;; This hashes cur-hash against the ctr-th hash in proof-hashes, and uses that as the next cur-hash.</a>
<a name="667"><span class="lineNum">     667 </span>                :            : ;; The path is a bitfield describing the walk from the txid up to the merkle root:</a>
<a name="668"><span class="lineNum">     668 </span>                :            : ;; * if the ith bit is 0, then cur-hash is hashed before the next proof-hash (cur-hash is &quot;left&quot;).</a>
<a name="669"><span class="lineNum">     669 </span>                :            : ;; * if the ith bit is 1, then the next proof-hash is hashed before cur-hash (cur-hash is &quot;right&quot;).</a>
<a name="670"><span class="lineNum">     670 </span>                :            : ;; The proof verifies if cur-hash is equal to root-hash, and we're out of proof-hashes to check.</a>
<a name="671"><span class="lineNum">     671 </span>                :            : (define-read-only (inner-merkle-proof-verify (ctr uint) (state { path: uint, root-hash: (buff 32), proof-hashes: (list 12 (buff 32)), tree-depth: uint, cur-hash: (buff 32), verified: bool }))</a>
<a name="672"><span class="lineNum">     672 </span>                :<span class="lineNoCov">          0 :     (if (get verified state)</span></a>
<a name="673"><span class="lineNum">     673 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         state</span></a>
<a name="674"><span class="lineNum">     674 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (if (&gt;= ctr (get tree-depth state))</span></a>
<a name="675"><span class="lineNum">     675 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (begin</span></a>
<a name="676"><span class="lineNum">     676 </span>                :            :                 ;; (print &quot;ctr exceeds proof length or tree depth&quot;)</a>
<a name="677"><span class="lineNum">     677 </span>                :            :                 ;; (print ctr)</a>
<a name="678"><span class="lineNum">     678 </span>                :            :                 ;; (print (get tree-depth state))</a>
<a name="679"><span class="lineNum">     679 </span>                :            :                 ;; (print (len (get proof-hashes state)))</a>
<a name="680"><span class="lineNum">     680 </span>                :<span class="lineNoCov">          0 :                 (merge state { verified: false })</span></a>
<a name="681"><span class="lineNum">     681 </span>                :            :             )</a>
<a name="682"><span class="lineNum">     682 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :             (let (</span></a>
<a name="683"><span class="lineNum">     683 </span>                :<span class="lineNoCov">          0 :                 (path (get path state))</span></a>
<a name="684"><span class="lineNum">     684 </span>                :<span class="lineNoCov">          0 :                 (is-left (is-bit-set path ctr))</span></a>
<a name="685"><span class="lineNum">     685 </span>                :<span class="lineNoCov">          0 :                 (proof-hashes (get proof-hashes state))</span></a>
<a name="686"><span class="lineNum">     686 </span>                :<span class="lineNoCov">          0 :                 (cur-hash (get cur-hash state))</span></a>
<a name="687"><span class="lineNum">     687 </span>                :<span class="lineNoCov">          0 :                 (root-hash (get root-hash state))</span></a>
<a name="688"><span class="lineNum">     688 </span>                :            : </a>
<a name="689"><span class="lineNum">     689 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (h1 (if is-left (unwrap-panic (element-at proof-hashes ctr)) cur-hash))</span></a>
<a name="690"><span class="lineNum">     690 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (h2 (if is-left cur-hash (unwrap-panic (element-at proof-hashes ctr))))</span></a>
<a name="691"><span class="lineNum">     691 </span>                :<span class="lineNoCov">          0 :                 (next-hash (sha256 (sha256 (concat h1 h2))))</span></a>
<a name="692"><span class="lineNum">     692 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :                 (is-verified (and (is-eq (+ u1 ctr) (len proof-hashes)) (is-eq next-hash root-hash)))</span></a>
<a name="693"><span class="lineNum">     693 </span>                :            :             )</a>
<a name="694"><span class="lineNum">     694 </span>                :<span class="lineNoCov">          0 :             (begin</span></a>
<a name="695"><span class="lineNum">     695 </span>                :            :                 ;; (print &quot;cur-hash&quot;)</a>
<a name="696"><span class="lineNum">     696 </span>                :            :                 ;; (print cur-hash)</a>
<a name="697"><span class="lineNum">     697 </span>                :            :                 ;; (print &quot;next-hash&quot;)</a>
<a name="698"><span class="lineNum">     698 </span>                :            :                 ;; (print h1)</a>
<a name="699"><span class="lineNum">     699 </span>                :            :                 ;; (print h2)</a>
<a name="700"><span class="lineNum">     700 </span>                :            :                 ;; (print next-hash)</a>
<a name="701"><span class="lineNum">     701 </span>                :<span class="lineNoCov">          0 :                 (merge state { cur-hash: next-hash, verified: is-verified })</span></a>
<a name="702"><span class="lineNum">     702 </span>                :            :             ))</a>
<a name="703"><span class="lineNum">     703 </span>                :            :         )</a>
<a name="704"><span class="lineNum">     704 </span>                :            :     )</a>
<a name="705"><span class="lineNum">     705 </span>                :            : )</a>
<a name="706"><span class="lineNum">     706 </span>                :            : </a>
<a name="707"><span class="lineNum">     707 </span>                :            : ;; Verify a Merkle proof, given the _reversed_ txid of a transaction, the merkle root of its block, and a proof consisting of:</a>
<a name="708"><span class="lineNum">     708 </span>                :            : ;; * The index in the block where the transaction can be found (starting from 0),</a>
<a name="709"><span class="lineNum">     709 </span>                :            : ;; * The list of hashes that link the txid to the merkle root,</a>
<a name="710"><span class="lineNum">     710 </span>                :            : ;; * The depth of the block's merkle tree (required because Bitcoin does not identify merkle tree nodes as being leaves or intermediates).</a>
<a name="711"><span class="lineNum">     711 </span>                :            : ;; The _reversed_ txid is required because that's the order (big-endian) processes them in.</a>
<a name="712"><span class="lineNum">     712 </span>                :            : ;; The tx-index is required because it tells us the left/right traversals we'd make if we were walking down the tree from root to transaction, </a>
<a name="713"><span class="lineNum">     713 </span>                :            : ;; and is thus used to deduce the order in which to hash the intermediate hashes with one another to link the txid to the merkle root.</a>
<a name="714"><span class="lineNum">     714 </span>                :            : ;; Returns (ok true) if the proof is valid.</a>
<a name="715"><span class="lineNum">     715 </span>                :            : ;; Returns (ok false) if the proof is invalid.</a>
<a name="716"><span class="lineNum">     716 </span>                :            : ;; Returns (err ERR-PROOF-TOO-SHORT) if the proof's hashes aren't long enough to link the txid to the merkle root.</a>
<a name="717"><span class="lineNum">     717 </span>                :            : (define-read-only (verify-merkle-proof (reversed-txid (buff 32)) (merkle-root (buff 32)) (proof { tx-index: uint, hashes: (list 12 (buff 32)), tree-depth: uint }))</a>
<a name="718"><span class="lineNum">     718 </span>                :<span class="lineNoCov">          0 :     (if (&gt; (get tree-depth proof) (len (get hashes proof)))</span></a>
<a name="719"><span class="lineNum">     719 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (err ERR-PROOF-TOO-SHORT)</span></a>
<a name="720"><span class="lineNum">     720 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :         (ok</span></a>
<a name="721"><span class="lineNum">     721 </span>                :<span class="lineNoCov">          0 :           (get verified</span></a>
<a name="722"><span class="lineNum">     722 </span>                :<span class="lineNoCov">          0 :               (fold inner-merkle-proof-verify</span></a>
<a name="723"><span class="lineNum">     723 </span>                :<span class="lineNoCov">          0 :                   (list u0 u1 u2 u3 u4 u5 u6 u7 u8 u9 u10 u11)</span></a>
<a name="724"><span class="lineNum">     724 </span>                :<span class="lineNoCov">          0 :                   { path: (+ (pow u2 (get tree-depth proof)) (get tx-index proof)), root-hash: merkle-root, proof-hashes: (get hashes proof), cur-hash: reversed-txid, tree-depth: (get tree-depth proof), verified: false }))</span></a>
<a name="725"><span class="lineNum">     725 </span>                :            :         )</a>
<a name="726"><span class="lineNum">     726 </span>                :            :     )</a>
<a name="727"><span class="lineNum">     727 </span>                :            : )</a>
<a name="728"><span class="lineNum">     728 </span>                :            : </a>
<a name="729"><span class="lineNum">     729 </span>                :            : ;; Top-level verification code to determine whether or not a Bitcoin transaction was mined in a prior Bitcoin block.</a>
<a name="730"><span class="lineNum">     730 </span>                :            : ;; It takes the block header and block height, the transaction, and a merkle proof, and determines that:</a>
<a name="731"><span class="lineNum">     731 </span>                :            : ;; * the block header corresponds to the block that was mined at the given Bitcoin height</a>
<a name="732"><span class="lineNum">     732 </span>                :            : ;; * the transaction's merkle proof links it to the block header's merkle root.</a>
<a name="733"><span class="lineNum">     733 </span>                :            : ;; The proof is a list of sibling merkle tree nodes that allow us to calculate the parent node from two children nodes in each merkle tree level,</a>
<a name="734"><span class="lineNum">     734 </span>                :            : ;; the depth of the block's merkle tree, and the index in the block in which the given transaction can be found (starting from 0).</a>
<a name="735"><span class="lineNum">     735 </span>                :            : ;; The first element in hashes must be the given transaction's sibling transaction's ID.  This and the given transaction's txid are hashed to </a>
<a name="736"><span class="lineNum">     736 </span>                :            : ;; calculate the parent hash in the merkle tree, which is then hashed with the *next* hash in the proof, and so on and so forth, until the final</a>
<a name="737"><span class="lineNum">     737 </span>                :            : ;; hash can be compared against the block header's merkle root field.  The tx-index tells us in which order to hash each pair of siblings.</a>
<a name="738"><span class="lineNum">     738 </span>                :            : ;; Note that the proof hashes -- including the sibling txid -- must be _big-endian_ hashes, because this is how Bitcoin generates them.</a>
<a name="739"><span class="lineNum">     739 </span>                :            : ;; This is the reverse of what you'd see in a block explorer!</a>
<a name="740"><span class="lineNum">     740 </span>                :            : ;; Returns (ok true) if the proof checks out.</a>
<a name="741"><span class="lineNum">     741 </span>                :            : ;; Returns (ok false) if not.</a>
<a name="742"><span class="lineNum">     742 </span>                :            : ;; Returns (err ERR-PROOF-TOO-SHORT) if the proof doesn't contain enough intermediate hash nodes in the merkle tree.</a>
<a name="743"><span class="lineNum">     743 </span>                :            : (define-read-only (was-tx-mined? (block { header: (buff 80), height: uint }) (tx (buff 1024)) (proof { tx-index: uint, hashes: (list 12 (buff 32)), tree-depth: uint }))</a>
<a name="744"><span class="lineNum">     744 </span>                :<span class="lineNoCov">          0 :   (let</span></a>
<a name="745"><span class="lineNum">     745 </span>                :            :     (</a>
<a name="746"><span class="lineNum">     746 </span>                :<span class="lineNoCov">          0 :       (header-valid (verify-block-header (get header block) (get height block)))</span></a>
<a name="747"><span class="lineNum">     747 </span>                :<span class="lineNoCov">          0 :       (reversed-txid (get-reversed-txid tx))</span></a>
<a name="748"><span class="lineNum">     748 </span>                :<span class="lineNoCov">          0 :       (parsed-header (try! (parse-block-header (get header block))))</span></a>
<a name="749"><span class="lineNum">     749 </span>                :<span class="lineNoCov">          0 :       (merkle-root (reverse-buff32 (get merkle-root parsed-header)))</span></a>
<a name="750"><span class="lineNum">     750 </span>                :<span class="lineNoCov">          0 :       (merkle-valid (verify-merkle-proof reversed-txid merkle-root proof))</span></a>
<a name="751"><span class="lineNum">     751 </span>                :            :     )</a>
<a name="752"><span class="lineNum">     752 </span>                :<span class="lineNoCov">          0 :     (if header-valid</span></a>
<a name="753"><span class="lineNum">     753 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :       merkle-valid</span></a>
<a name="754"><span class="lineNum">     754 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :       (ok false)</span></a>
<a name="755"><span class="lineNum">     755 </span>                :            :     )</a>
<a name="756"><span class="lineNum">     756 </span>                :            :   )</a>
<a name="757"><span class="lineNum">     757 </span>                :            : )</a>
<a name="758"><span class="lineNum">     758 </span>                :            : </a>
<a name="759"><span class="lineNum">     759 </span>                :            : (define-read-only (verify-prev-block (block (buff 80)) (parent (buff 80)))</a>
<a name="760"><span class="lineNum">     760 </span>                :<span class="lineNoCov">          0 :   (let</span></a>
<a name="761"><span class="lineNum">     761 </span>                :            :     (</a>
<a name="762"><span class="lineNum">     762 </span>                :<span class="lineNoCov">          0 :       (parent-hash (sha256 (sha256 parent)))</span></a>
<a name="763"><span class="lineNum">     763 </span>                :<span class="lineNoCov">          0 :       (parent-reversed (reverse-buff32 parent-hash))</span></a>
<a name="764"><span class="lineNum">     764 </span>                :<span class="lineNoCov">          0 :       (parsed (try! (parse-block-header block)))</span></a>
<a name="765"><span class="lineNum">     765 </span>                :<span class="lineNoCov">          0 :       (parsed-parent (get parent parsed))</span></a>
<a name="766"><span class="lineNum">     766 </span>                :            :     )</a>
<a name="767"><span class="lineNum">     767 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :     (asserts! (is-eq parsed-parent parent-reversed) (err ERR-INVALID-PARENT))</span></a>
<a name="768"><span class="lineNum">     768 </span>                :<span class="lineNoCov">          0 :     (ok true)</span></a>
<a name="769"><span class="lineNum">     769 </span>                :            :   )</a>
<a name="770"><span class="lineNum">     770 </span>                :            : )</a>
<a name="771"><span class="lineNum">     771 </span>                :            : </a>
<a name="772"><span class="lineNum">     772 </span>                :            : (define-read-only (verify-prev-blocks (block (buff 80)) (prev-blocks (list 10 (buff 80))))</a>
<a name="773"><span class="lineNum">     773 </span>                :<span class="lineNoCov">          0 :   (let</span></a>
<a name="774"><span class="lineNum">     774 </span>                :            :     (</a>
<a name="775"><span class="lineNum">     775 </span>                :<span class="lineNoCov">          0 :       (iterator (ok block))</span></a>
<a name="776"><span class="lineNum">     776 </span>                :<span class="lineNoCov">          0 :       (fold-resp (fold verify-prev-blocks-fold prev-blocks iterator))</span></a>
<a name="777"><span class="lineNum">     777 </span>                :<span class="lineNoCov">          0 :       (last-block (try! fold-resp))</span></a>
<a name="778"><span class="lineNum">     778 </span>                :            :     )</a>
<a name="779"><span class="lineNum">     779 </span>                :<span class="lineNoCov">          0 :     (ok last-block)</span></a>
<a name="780"><span class="lineNum">     780 </span>                :            :   )</a>
<a name="781"><span class="lineNum">     781 </span>                :            : )</a>
<a name="782"><span class="lineNum">     782 </span>                :            : </a>
<a name="783"><span class="lineNum">     783 </span>                :            : (define-read-only (verify-prev-blocks-fold </a>
<a name="784"><span class="lineNum">     784 </span>                :            :     (parent (buff 80))</a>
<a name="785"><span class="lineNum">     785 </span>                :            :     (next-resp (response (buff 80) uint))</a>
<a name="786"><span class="lineNum">     786 </span>                :            :   )</a>
<a name="787"><span class="lineNum">     787 </span>                :<span class="lineNoCov">          0 :   (let</span></a>
<a name="788"><span class="lineNum">     788 </span>                :            :     (</a>
<a name="789"><span class="lineNum">     789 </span>                :<span class="lineNoCov">          0 :       (next (try! next-resp))</span></a>
<a name="790"><span class="lineNum">     790 </span>                :<span class="lineNoCov">          0 :       (is-valid (try! (verify-prev-block next parent)))</span></a>
<a name="791"><span class="lineNum">     791 </span>                :            :     )</a>
<a name="792"><span class="lineNum">     792 </span>                :<span class="lineNoCov">          0 :     (ok parent)</span></a>
<a name="793"><span class="lineNum">     793 </span>                :            :   )</a>
<a name="794"><span class="lineNum">     794 </span>                :            : )</a>
<a name="795"><span class="lineNum">     795 </span>                :            : </a>
<a name="796"><span class="lineNum">     796 </span>                :            : (define-read-only (was-tx-mined-prev? (block { header: (buff 80), height: uint }) (prev-blocks (list 10 (buff 80))) (tx (buff 1024)) (proof { tx-index: uint, hashes: (list 12 (buff 32)), tree-depth: uint }))</a>
<a name="797"><span class="lineNum">     797 </span>                :<span class="lineNoCov">          0 :   (let</span></a>
<a name="798"><span class="lineNum">     798 </span>                :            :     (</a>
<a name="799"><span class="lineNum">     799 </span>                :<span class="lineNoCov">          0 :       (header-valid (verify-block-header (get header block) (get height block)))</span></a>
<a name="800"><span class="lineNum">     800 </span>                :<span class="lineNoCov">          0 :       (previous-block (try! (verify-prev-blocks (get header block) prev-blocks)))</span></a>
<a name="801"><span class="lineNum">     801 </span>                :<span class="lineNoCov">          0 :       (reversed-txid (get-reversed-txid tx))</span></a>
<a name="802"><span class="lineNum">     802 </span>                :<span class="lineNoCov">          0 :       (parsed-header (try! (parse-block-header previous-block)))</span></a>
<a name="803"><span class="lineNum">     803 </span>                :<span class="lineNoCov">          0 :       (merkle-root (reverse-buff32 (get merkle-root parsed-header)))</span></a>
<a name="804"><span class="lineNum">     804 </span>                :<span class="lineNoCov">          0 :       (merkle-valid (verify-merkle-proof reversed-txid merkle-root proof))</span></a>
<a name="805"><span class="lineNum">     805 </span>                :            :     )</a>
<a name="806"><span class="lineNum">     806 </span>                :<span class="lineNoCov">          0 :     (if header-valid</span></a>
<a name="807"><span class="lineNum">     807 </span>           [<span class="branchNoCov" title="Branch 0 was not taken"> - </span>]:<span class="lineNoCov">          0 :       merkle-valid</span></a>
<a name="808"><span class="lineNum">     808 </span>           [<span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineNoCov">          0 :       (ok false)</span></a>
<a name="809"><span class="lineNum">     809 </span>                :            :     )</a>
<a name="810"><span class="lineNum">     810 </span>                :            :   )</a>
<a name="811"><span class="lineNum">     811 </span>                :            : )</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
